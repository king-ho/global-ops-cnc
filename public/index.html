<!DOCTYPE html>
<html lang="en" dir="ltr">
<!--

QNET : Crew Clients 172.16
Shipsnet : 192.168
Priority :

Manual Sync
Mail Sync = Centos7 SirusMail at .1
Webcam Sync = Grabs still from camera share, stores on WTS and pushes to shore
Noon Sync = Connects to app server at .13 and pushes to 31.6 (mailserver) on shore
Mail Queues = Outgoing / Failed lists folders on .1
Drive Sync = on/off scheduled sync. Pulls, converts to PDF
Logs = logs from .1
Webcam management = selects which camera to Sync
-->

<head>

  <script src="./js/jquery.latest.min.js"></script>
  <script src="./js/jquery.connections.js"></script>
  <script src="./js/d3.min.js"></script>
  <script src="./js/moment.min.js"></script>
  <link type="text/css" rel="stylesheet" href="./css/materialicons.css" media="screen,projection" />
  <link type="text/css" rel="stylesheet" href="./css/materialize.min.css" media="screen,projection" />


  <!-- Connect your elements like in this example -->
  <script>
    var svgContainer
    let networks
    let gateways
    let target
    jQuery(document).ready(function() {
      //get firewallpolicy
      $.get( "/getfirewallpolicy",function(currentfirewalldata){
        if(typeof currentfirewalldata == "object"){
          $.get("/networks",function(networkdata){
            console.log(currentfirewalldata)
            for(var i = 0 ; i < networkdata.QNET.networks.length; i++){
              for(var cur in currentfirewalldata) {
                if(networkdata.QNET.networks[i].firewallpolicy == cur){
                  //console.log("network firewallpolicy id for QNET " + networkdata.QNET.networks[i].firewallpolicy + " == "+ cur + " with status "+ currentfirewalldata[cur].status)
                  if (currentfirewalldata[cur].status == undefined){
                    $(".QNET").attr("gateway",networkdata.QNET.networks[i].name)
                    drawLine("QNET")
                    $("#gwloader").html("")
                  }
                }
              }
            }
            for(var i = 0 ; i < networkdata.MEDIANET.networks.length; i++){
              for(var cur in currentfirewalldata) {
                if(networkdata.MEDIANET.networks[i].firewallpolicy == cur){
                  //console.log("network firewallpolicy id for MEDIANET " + networkdata.MEDIANET.networks[i].firewallpolicy + " == "+ cur + " with status "+ currentfirewalldata[cur].status)
                  if (currentfirewalldata[cur].status == undefined){
                    $(".MEDIANET").attr("gateway",networkdata.MEDIANET.networks[i].name)
                    drawLine("MEDIANET")
                  }
                }
              }
            }
          })
        } else {
          console.log("could not get current firewalldata")
        }
      })

      $.get( "/refreshmail",function(refreshdata){
        target=refreshdata.nummails
        if(refreshdata.status=="refreshed"){
          console.log(refreshdata.nummails)
          getmails()
        }
      } );
      svgContainer = d3.select("body").append("svg")
                                       .attr("width", "100%")
                                       .attr("height", "100%")
                                       .attr("style", "position:absolute;top:0;pointer-events:none");
      networks = ["QNET", "MEDIANET"]
      for (var i = 0; i < networks.length; i++) {
        $(".networks").append('<button class="network pure-button '+networks[i]+'">' + networks[i] + '</button>')
      }
      $(".network").click(function(){
        $(".network").not(this).prop('disabled', true);
        console.log($(this).text())
        $(this).addClass('selectednet')
        selectNetwork($(this).text())

      })
      gateways = [ "WAN-WIFI", "WAN-VSAT-FX", "WAN-VSAT-KU", "WAN-FBB", "WAN-4G", "WAN-3G"]
      for (var i = 0; i < gateways.length; i++) {
        $(".gateways").append('<button class="pure-button gw '+gateways[i]+'">' + gateways[i] + '</button>')
      }
      $('.gw').prop('disabled', true);
      $(".gw").click(function(){
        console.log($(this).text())
        $(".gw").prop('disabled', true);
        connect($($(".selectednet")[0]).text(),$(this).text())
        $(".network").removeClass('selectednet')
        $(".network").prop('disabled', false);
      })
      jQuery('#parent').connections({
        to: '.child',
        css: {
          borderStyle: "double"
        }
      });
    });
    function selectNetwork(gateway){
      $(".gw").prop('disabled', false);
    }
    function connect(network, gateway){
      console.log("connecting " + network + " to " + gateway)
      $("."+network).attr("gateway",gateway)
      $.get( "/set?network="+network+"&gateway="+gateway );
      drawLine(network)
    }

    function drawLine(network){
      let gateway = $("."+network).attr("gateway")
      console.log(network + " - " + gateway)
      if(gateway != ""){
        d3.select("."+network+"_line").remove()
        var line = svgContainer.append("line")
          .attr("x1", $("."+network).offset().left+$("."+network).width()/2+20)
          .attr("y1", $("."+network).offset().top+$("."+network).height()+20)
          .attr("x2", $("."+gateway).offset().left+$("."+gateway).width()/2+20)
          .attr("y2", $("."+gateway).offset().top)
          .attr("stroke-width", 2)
          .attr("stroke", "black")
          .attr("class",network+"_line lern")
      }
    }
    var resizeTimer;
    function getmails(){
      $.get("/getmails",function(data){
        if(data.length<target){
          $("#mailloader").text("- loading: [ "+data.length+" / "+target+" ] "+Math.floor(100*data.length/target)+"%")
          setTimeout(function(){
            getmails()
          },1500)
        } else {
          console.log("successfully got " + data.length + " mails")
          $("#mailloader").fadeOut()
          for (var mailnr = 0; mailnr < data.length; mailnr++) {
            $("#mailcontentlist").append("<tr><td>"+data[mailnr].date+"</td><td nowrap title='"+data[mailnr].from+"'>"+data[mailnr].from+"</td><td nowrap title='"+data[mailnr].to+"'>"+data[mailnr].to+"</td><td nowrap title='"+data[mailnr].title+"'>"+data[mailnr].title+"</td><td>"+data[mailnr].size+"</td><td>"+data[mailnr].type+"</td><td><i class='material-icons'>check_circle_outline</i></td></tr>")
          }
        }
      })
    }
    $(window).on('resize', function(e) {
      $(".lern").remove()
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(function() {

        for (var i = 0; i < networks.length; i++) {
          if($("."+networks[i]).attr("gateway")){
            drawLine(networks[i])
          }
        }

      }, 150);

    });
    function sortTable(n) {
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.getElementById("mails");
    switching = true;
    // Set the sorting direction to ascending:
    dir = "asc";
    /* Make a loop that will continue until
    no switching has been done: */
    while (switching) {
      // Start by saying: no switching is done:
      switching = false;
      rows = table.rows;
      /* Loop through all table rows (except the
      first, which contains table headers): */
      for (i = 1; i < (rows.length - 1); i++) {
        // Start by saying there should be no switching:
        shouldSwitch = false;
        /* Get the two elements you want to compare,
        one from current row and one from the next: */
        x = rows[i].getElementsByTagName("TD")[n];
        y = rows[i + 1].getElementsByTagName("TD")[n];
        /* Check if the two rows should switch place,
        based on the direction, asc or desc: */
        if (dir == "asc") {
          if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
            // If so, mark as a switch and break the loop:
            shouldSwitch = true;
            break;
          }
        } else if (dir == "desc") {
          if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
            // If so, mark as a switch and break the loop:
            shouldSwitch = true;
            break;
          }
        }
      }
      if (shouldSwitch) {
        /* If a switch has been marked, make the switch
        and mark that a switch has been done: */
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
        // Each time a switch is done, increase this count by 1:
        switchcount ++;
      } else {
        /* If no switching has been done AND the direction is "asc",
        set the direction to "desc" and run the while loop again. */
        if (switchcount == 0 && dir == "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }
  }
  </script>
  <meta charset="utf-8">
  <link rel="stylesheet" href="./css/pure-min.css">
  <title>CNC</title>
  <style media="screen">
  html{
    background:rgba(40, 84, 108 ,0.4)
  }
    connection {
      border: 5px solid green;
      border-radius: 100%;
    }

    .divider {
      background: none;
      height:200px;
    }
    svg {
      height:120%;
      width:100%;
    }
    .networks, .gateways {
      display: flex;
      justify-content: center;
    }

    .networks>button, .gateways>button {

      margin: 10px;
      letter-spacing: 3px;
      text-align: center;
      line-height: 75px;
      font-size: 16px;
    }
    .pure-button {
      margin:10px;
    }
    .inner {
      margin: 30px;
      margin-left:75px;
      float:left;
      overflow:scroll;
      scrollbar-color: transparent transparent;
    }
    table{
      table-layout: fixed
    }
    table.space{
      border-spacing: 15px 10px;
    }
    td, th{
      overflow:hidden;
    }
    ::-webkit-scrollbar {
        display: none;
    }
    .log{
      position:absolute;
      right:0;
      margin-top:-5px;
      margin-right:25px;
      text-align:center;
      width:70%;
      background:black;
      color:white;
      text-align:left;
      padding-left:15px;
      height:416px;
      line-height:40px;
      float:right;
      font-size:18px;
      font-family: Courier New;
    }
    .selectednet {
      background:green
    }
    fieldset{
      color:white;
       margin:0;
      border:0px;
      background:rgba(40, 120, 77 ,0.7);
      display:flex;
    }
    fieldset:nth-child(2n){
      background:rgba(40, 84, 108 ,0.7);
      -webkit-box-shadow: inset 0px 1px 16px -2px rgba(0,0,0,0.43);
-moz-box-shadow: inset 0px 1px 16px -2px rgba(0,0,0,0.43);
box-shadow: inset 0px 1px 16px -2px rgba(0,0,0,0.43);
    }
    .fstitle{
      position:absolute;
      margin-top:-5px;
      margin-left:-10px;
      text-align:center;
      padding-left:20px;
      padding-right:20px;
      background:rgb(170, 82, 57);
      height:40px;
      line-height:40px;
    }
  </style>
</head>

<body>
  <fieldset class="gatewayfs">
    <div class="fstitle">
      Gateway <span id="gwloader"> - loading</span>
    </div><br>
    <div class="networks pure-g">

    </div>
    <div class="divider">

    </div>
    <div class="gateways pure-g">

    </div>
  </fieldset>
  <fieldset style="height:400px;overflow:scroll">

    <div class="fstitle">
      Mail <span id="mailloader"> - loading</span>
    </div><br>
    <div style="margin:0;margin-top:30px" class="inner">
      <table id="mails">
        <thead>
          <tr>
            <th style="width:60px">date</th>
            <th>from</th>
            <th>to</th>
            <th>subject</th>
            <th style="width:50px">size</th>
            <th style="width:50px">status</th>
            <th style="width:22px"></th>
          </tr>
        </thead>
        <tbody id="mailcontentlist">

        </tbody>
      </table>
    </div>

  </fieldset>
  <fieldset class="fiddy">
    <div class="fstitle">
      Manual Sync
    </div><br>
    <div class="inner" style="display: flex;flex-wrap:wrap">
      <button style="flex: 1;" class="drivemanual pure-button">Drive Sync</button>
      <button  style="flex: 1;" class="driveoptions pure-button">Drive Options</button>
      <button  style="flex: 1;" class="pure-button">Noon Sync</button>
      <button  style="flex: 1;" class="pure-button">User WiFi Account Sync</button>
      <button  style="flex: 1;" class="cammanual pure-button">Webcam Sync</button>
    </div>
  </fieldset>
  <fieldset class="fiddy">
    <div class="fstitle">
      Webcam Previews
    </div><br>
    <div class="inner">

    </div>
  </fieldset>

</body>

</html>
